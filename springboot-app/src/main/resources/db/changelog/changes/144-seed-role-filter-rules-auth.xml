<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="144-seed-role-filter-rules-auth" author="system">
        <comment>Seed role filter rules for authentication and security resources: refresh_token, permission</comment>

        <!-- ============= REFRESH_TOKEN PERMISSIONS ============= -->
        <!-- ADMIN: Full access to all refresh tokens (for security monitoring) -->
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-148"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'ADMIN' LIMIT 1)"/>
            <column name="permission_key" value="refresh_token:CREATE"/>
            <column name="filter_type" value="ALL"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-149"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'ADMIN' LIMIT 1)"/>
            <column name="permission_key" value="refresh_token:READ"/>
            <column name="filter_type" value="ALL"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-150"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'ADMIN' LIMIT 1)"/>
            <column name="permission_key" value="refresh_token:UPDATE"/>
            <column name="filter_type" value="ALL"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-151"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'ADMIN' LIMIT 1)"/>
            <column name="permission_key" value="refresh_token:DELETE"/>
            <column name="filter_type" value="ALL"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>

        <!-- INSTRUCTOR: Create, read, update own refresh tokens -->
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-152"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'INSTRUCTOR' LIMIT 1)"/>
            <column name="permission_key" value="refresh_token:CREATE"/>
            <column name="filter_type" value="ALL"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-153"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'INSTRUCTOR' LIMIT 1)"/>
            <column name="permission_key" value="refresh_token:READ"/>
            <column name="filter_type" value="OWN"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-154"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'INSTRUCTOR' LIMIT 1)"/>
            <column name="permission_key" value="refresh_token:UPDATE"/>
            <column name="filter_type" value="OWN"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-155"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'INSTRUCTOR' LIMIT 1)"/>
            <column name="permission_key" value="refresh_token:DELETE"/>
            <column name="filter_type" value="OWN"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>

        <!-- STUDENT: Create, read, update own refresh tokens -->
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-156"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'STUDENT' LIMIT 1)"/>
            <column name="permission_key" value="refresh_token:CREATE"/>
            <column name="filter_type" value="ALL"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-157"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'STUDENT' LIMIT 1)"/>
            <column name="permission_key" value="refresh_token:READ"/>
            <column name="filter_type" value="OWN"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-158"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'STUDENT' LIMIT 1)"/>
            <column name="permission_key" value="refresh_token:UPDATE"/>
            <column name="filter_type" value="OWN"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-159"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'STUDENT' LIMIT 1)"/>
            <column name="permission_key" value="refresh_token:DELETE"/>
            <column name="filter_type" value="OWN"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>

        <!-- ============= PERMISSION PERMISSIONS ============= -->
        <!-- ADMIN: Full access to all permissions (system configuration) -->
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-160"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'ADMIN' LIMIT 1)"/>
            <column name="permission_key" value="permission:CREATE"/>
            <column name="filter_type" value="ALL"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-161"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'ADMIN' LIMIT 1)"/>
            <column name="permission_key" value="permission:READ"/>
            <column name="filter_type" value="ALL"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-162"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'ADMIN' LIMIT 1)"/>
            <column name="permission_key" value="permission:UPDATE"/>
            <column name="filter_type" value="ALL"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-163"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'ADMIN' LIMIT 1)"/>
            <column name="permission_key" value="permission:DELETE"/>
            <column name="filter_type" value="ALL"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>

        <!-- INSTRUCTOR: Read permissions (to understand their capabilities) -->
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-164"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'INSTRUCTOR' LIMIT 1)"/>
            <column name="permission_key" value="permission:READ"/>
            <column name="filter_type" value="ALL"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>

        <!-- STUDENT: Read permissions (to understand their capabilities) -->
        <insert tableName="role_filter_rules">
            <column name="id" value="rfr-165"/>
            <column name="role_id" valueComputed="(SELECT id FROM user_roles WHERE role = 'STUDENT' LIMIT 1)"/>
            <column name="permission_key" value="permission:READ"/>
            <column name="filter_type" value="ALL"/>
            <column name="is_active" valueBoolean="true"/>
        </insert>

        <rollback>
            <delete tableName="role_filter_rules">
                <where>id IN ('rfr-148', 'rfr-149', 'rfr-150', 'rfr-151', 'rfr-152', 'rfr-153', 'rfr-154', 'rfr-155', 'rfr-156', 'rfr-157', 'rfr-158', 'rfr-159', 'rfr-160', 'rfr-161', 'rfr-162', 'rfr-163', 'rfr-164', 'rfr-165')</where>
            </delete>
        </rollback>
    </changeSet>

</databaseChangeLog>
