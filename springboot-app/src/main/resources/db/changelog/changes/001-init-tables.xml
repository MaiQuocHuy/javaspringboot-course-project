<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
      http://www.liquibase.org/xml/ns/dbchangelog
      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <!-- User table -->
    <changeSet id="1" author="ktc">
        <createTable tableName="USER">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
    </changeSet>

    <!-- UserRole table -->
    <changeSet id="2" author="ktc">
        <createTable tableName="USER_ROLE">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint tableName="USER_ROLE" columnNames="user_id,role" constraintName="unique_user_role"/>
        <addForeignKeyConstraint baseTableName="USER_ROLE" baseColumnNames="user_id" referencedTableName="USER" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_userrole_user"/>
    </changeSet>

    <!-- RefreshToken table -->
    <changeSet id="3" author="ktc">
        <createTable tableName="REFRESH_TOKEN">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="token" type="VARCHAR(512)">
                <constraints nullable="false"/>
            </column>
            <column name="expires_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="is_revoked" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <createIndex tableName="REFRESH_TOKEN" indexName="idx_user_id">
            <column name="user_id"/>
        </createIndex>
        <addUniqueConstraint tableName="REFRESH_TOKEN" columnNames="token" constraintName="idx_token"/>
        <addForeignKeyConstraint baseTableName="REFRESH_TOKEN" baseColumnNames="user_id" referencedTableName="USER" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_refreshtoken_user"/>
    </changeSet>

    <!-- Category table -->
    <changeSet id="4" author="ktc">
        <createTable tableName="CATEGORY">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
    </changeSet>

    <!-- Course table -->
    <changeSet id="5" author="ktc">
        <createTable tableName="COURSE">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="instructor_id" type="VARCHAR(36)"/>
            <column name="price" type="DECIMAL(10,2)" defaultValueNumeric="0.00"/>
            <column name="is_published" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="is_approved" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="is_deleted" type="BOOLEAN" defaultValueBoolean="false"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <createIndex tableName="COURSE" indexName="idx_instructor">
            <column name="instructor_id"/>
        </createIndex>
        <createIndex tableName="COURSE" indexName="idx_title">
            <column name="title"/>
        </createIndex>
        <addForeignKeyConstraint baseTableName="COURSE" baseColumnNames="instructor_id" referencedTableName="USER" referencedColumnNames="id" onDelete="SET NULL" constraintName="fk_course_instructor"/>
    </changeSet>

    <!-- CourseCategory table -->
    <changeSet id="6" author="ktc">
        <createTable tableName="COURSE_CATEGORY">
            <column name="course_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="category_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="COURSE_CATEGORY" columnNames="course_id,category_id"/>
        <addForeignKeyConstraint baseTableName="COURSE_CATEGORY" baseColumnNames="course_id" referencedTableName="COURSE" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_coursecategory_course"/>
        <addForeignKeyConstraint baseTableName="COURSE_CATEGORY" baseColumnNames="category_id" referencedTableName="CATEGORY" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_coursecategory_category"/>
    </changeSet>

    <!-- Section table -->
    <changeSet id="7" author="ktc">
        <createTable tableName="SECTION">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="course_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="order_index" type="INT" defaultValueNumeric="0"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <createIndex tableName="SECTION" indexName="idx_course">
            <column name="course_id"/>
        </createIndex>
        <addUniqueConstraint tableName="SECTION" columnNames="course_id,order_index" constraintName="unique_section_order"/>
        <addForeignKeyConstraint baseTableName="SECTION" baseColumnNames="course_id" referencedTableName="COURSE" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_section_course"/>
    </changeSet>

    <!-- Additional tables (VIDEO_CONTENT, LESSON, ENROLLMENT, etc.) would follow the same pattern -->

    <!-- VideoContent table -->
    <changeSet id="8" author="ktc">
        <createTable tableName="VIDEO_CONTENT">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="url" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="duration" type="INT"/>
            <column name="uploaded_by" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="VIDEO_CONTENT" baseColumnNames="uploaded_by" referencedTableName="USER" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_videocontent_user"/>
    </changeSet>

    <!-- Lesson table -->
    <changeSet id="9" author="ktc">
        <createTable tableName="LESSON">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="section_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="title" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(10)" defaultValue="VIDEO"/>
            <column name="content_id" type="VARCHAR(36)"/>
            <column name="order_index" type="INT" defaultValueNumeric="0"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <createIndex tableName="LESSON" indexName="idx_section">
            <column name="section_id"/>
        </createIndex>
        <addUniqueConstraint tableName="LESSON" columnNames="section_id,order_index" constraintName="unique_lesson_order"/>
        <addForeignKeyConstraint baseTableName="LESSON" baseColumnNames="section_id" referencedTableName="SECTION" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_lesson_section"/>
        <addForeignKeyConstraint baseTableName="LESSON" baseColumnNames="content_id" referencedTableName="VIDEO_CONTENT" referencedColumnNames="id" onDelete="SET NULL" constraintName="fk_lesson_content"/>
    </changeSet>

    <!-- Enrollment table -->
    <changeSet id="10" author="ktc">
        <createTable tableName="ENROLLMENT">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="course_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="enrolled_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="completion_status" type="VARCHAR(20)" defaultValue="IN_PROGRESS"/>
        </createTable>
        <addUniqueConstraint tableName="ENROLLMENT" columnNames="user_id,course_id" constraintName="unique_enrollment"/>
        <addForeignKeyConstraint baseTableName="ENROLLMENT" baseColumnNames="user_id" referencedTableName="USER" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_enrollment_user"/>
        <addForeignKeyConstraint baseTableName="ENROLLMENT" baseColumnNames="course_id" referencedTableName="COURSE" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_enrollment_course"/>
    </changeSet>

    <!-- LessonCompletion table -->
    <changeSet id="11" author="ktc">
        <createTable tableName="LESSON_COMPLETION">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="lesson_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="completed_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addUniqueConstraint tableName="LESSON_COMPLETION" columnNames="user_id,lesson_id" constraintName="unique_completion"/>
        <addForeignKeyConstraint baseTableName="LESSON_COMPLETION" baseColumnNames="user_id" referencedTableName="USER" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_lessoncompletion_user"/>
        <addForeignKeyConstraint baseTableName="LESSON_COMPLETION" baseColumnNames="lesson_id" referencedTableName="LESSON" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_lessoncompletion_lesson"/>
    </changeSet>

    <!-- Review table -->
    <changeSet id="12" author="ktc">
        <createTable tableName="REVIEW">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="course_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="rating" type="INT" defaultValueNumeric="5"/>
            <column name="review_text" type="TEXT"/>
            <column name="reviewed_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addUniqueConstraint tableName="REVIEW" columnNames="user_id,course_id" constraintName="unique_review"/>
        <createIndex tableName="REVIEW" indexName="idx_course">
            <column name="course_id"/>
        </createIndex>
        <addForeignKeyConstraint baseTableName="REVIEW" baseColumnNames="user_id" referencedTableName="USER" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_review_user"/>
        <addForeignKeyConstraint baseTableName="REVIEW" baseColumnNames="course_id" referencedTableName="COURSE" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_review_course"/>
    </changeSet>

    <!-- Payment table -->
    <changeSet id="13" author="ktc">
        <createTable tableName="PAYMENT">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="course_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="PENDING"/>
            <column name="payment_method" type="VARCHAR(50)"/>
            <column name="paid_at" type="TIMESTAMP"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <createIndex tableName="PAYMENT" indexName="idx_user">
            <column name="user_id"/>
        </createIndex>
        <createIndex tableName="PAYMENT" indexName="idx_course">
            <column name="course_id"/>
        </createIndex>
        <createIndex tableName="PAYMENT" indexName="idx_status">
            <column name="status"/>
        </createIndex>
        <addForeignKeyConstraint baseTableName="PAYMENT" baseColumnNames="user_id" referencedTableName="USER" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_payment_user"/>
        <addForeignKeyConstraint baseTableName="PAYMENT" baseColumnNames="course_id" referencedTableName="COURSE" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_payment_course"/>
    </changeSet>

    <!-- Refund table -->
    <changeSet id="14" author="ktc">
        <createTable tableName="REFUND">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="payment_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="PENDING"/>
            <column name="reason" type="TEXT"/>
            <column name="requested_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="processed_at" type="TIMESTAMP"/>
        </createTable>
        <addUniqueConstraint tableName="REFUND" columnNames="payment_id" constraintName="unique_payment"/>
        <createIndex tableName="REFUND" indexName="idx_status">
            <column name="status"/>
        </createIndex>
        <addForeignKeyConstraint baseTableName="REFUND" baseColumnNames="payment_id" referencedTableName="PAYMENT" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_refund_payment"/>
    </changeSet>

    <!-- InstructorEarning table -->
    <changeSet id="15" author="ktc">
        <createTable tableName="INSTRUCTOR_EARNING">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="instructor_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="payment_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="course_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="DECIMAL(10,2)">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)" defaultValue="PENDING"/>
            <column name="available_at" type="TIMESTAMP"/>
            <column name="paid_at" type="TIMESTAMP"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <createIndex tableName="INSTRUCTOR_EARNING" indexName="idx_instructor">
            <column name="instructor_id"/>
        </createIndex>
        <addUniqueConstraint tableName="INSTRUCTOR_EARNING" columnNames="payment_id" constraintName="unique_payment"/>
        <createIndex tableName="INSTRUCTOR_EARNING" indexName="idx_status">
            <column name="status"/>
        </createIndex>
        <addForeignKeyConstraint baseTableName="INSTRUCTOR_EARNING" baseColumnNames="instructor_id" referencedTableName="USER" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_instructorearning_instructor"/>
        <addForeignKeyConstraint baseTableName="INSTRUCTOR_EARNING" baseColumnNames="payment_id" referencedTableName="PAYMENT" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_instructorearning_payment"/>
        <addForeignKeyConstraint baseTableName="INSTRUCTOR_EARNING" baseColumnNames="course_id" referencedTableName="COURSE" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_instructorearning_course"/>
    </changeSet>

    <!-- InstructorApplication table -->
    <changeSet id="16" author="ktc">
        <createTable tableName="INSTRUCTOR_APPLICATION">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="reviewed_by" type="VARCHAR(36)"/>
            <column name="status" type="VARCHAR(20)" defaultValue="PENDING"/>
            <column name="documents" type="JSON"/>
            <column name="submitted_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="reviewed_at" type="TIMESTAMP"/>
            <column name="rejection_reason" type="TEXT"/>
        </createTable>
        <addUniqueConstraint tableName="INSTRUCTOR_APPLICATION" columnNames="user_id" constraintName="unique_application"/>
        <createIndex tableName="INSTRUCTOR_APPLICATION" indexName="idx_status">
            <column name="status"/>
        </createIndex>
        <addForeignKeyConstraint baseTableName="INSTRUCTOR_APPLICATION" baseColumnNames="user_id" referencedTableName="USER" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_instructorapplication_user"/>
        <addForeignKeyConstraint baseTableName="INSTRUCTOR_APPLICATION" baseColumnNames="reviewed_by" referencedTableName="USER" referencedColumnNames="id" onDelete="SET NULL" constraintName="fk_instructorapplication_reviewer"/>
    </changeSet>

    <!-- QuizQuestion table -->
    <changeSet id="17" author="ktc">
        <createTable tableName="QUIZ_QUESTION">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="lesson_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="question_text" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="options" type="JSON">
                <constraints nullable="false"/>
            </column>
            <column name="correct_answer" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="explanation" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <createIndex tableName="QUIZ_QUESTION" indexName="idx_lesson">
            <column name="lesson_id"/>
        </createIndex>
        <addForeignKeyConstraint baseTableName="QUIZ_QUESTION" baseColumnNames="lesson_id" referencedTableName="LESSON" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_quizquestion_lesson"/>
    </changeSet>

    <!-- QuizResult table -->
    <changeSet id="18" author="ktc">
        <createTable tableName="QUIZ_RESULT">
            <column name="id" type="VARCHAR(36)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="lesson_id" type="VARCHAR(36)">
                <constraints nullable="false"/>
            </column>
            <column name="score" type="DECIMAL(5,2)"/>
            <column name="answers" type="JSON"/>
            <column name="completed_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <addUniqueConstraint tableName="QUIZ_RESULT" columnNames="user_id,lesson_id" constraintName="unique_result"/>
        <addForeignKeyConstraint baseTableName="QUIZ_RESULT" baseColumnNames="user_id" referencedTableName="USER" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_quizresult_user"/>
        <addForeignKeyConstraint baseTableName="QUIZ_RESULT" baseColumnNames="lesson_id" referencedTableName="LESSON" referencedColumnNames="id" onDelete="CASCADE" constraintName="fk_quizresult_lesson"/>
    </changeSet>

</databaseChangeLog> 